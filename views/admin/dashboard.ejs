<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Today - Boomer AI</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root {
      --sidebar-bg: <%= branding?.primaryColor || '#16a34a' %>;
      --sidebar-bg-dark: <%= branding?.secondaryColor || '#15803d' %>;
      --accent-color: <%= branding?.accentColor || '#22c55e' %>;
    }
    .sidebar { min-height: 100vh; background: var(--sidebar-bg); }
    .sidebar .nav-link { color: rgba(255,255,255,0.8); padding: 0.75rem 1rem; }
    .sidebar .nav-link:hover, .sidebar .nav-link.active { color: #fff; background: rgba(255,255,255,0.1); }
    .sidebar .nav-link i { margin-right: 0.5rem; }
    .main-content { background: #f8f9fa; min-height: 100vh; }
    .nav-divider { border-top: 1px solid rgba(255,255,255,0.2); margin: 0.5rem 0; }
    .nav-section { color: rgba(255,255,255,0.5); font-size: 0.75rem; padding: 0.5rem 1rem; text-transform: uppercase; }
    .stat-card { border-radius: 12px; border: none; }
    .stat-card .stat-icon { font-size: 2.5rem; opacity: 0.8; }
    .stat-card .stat-value { font-size: 2rem; font-weight: bold; }
    .greeting { font-size: 1.5rem; color: var(--sidebar-bg); }
    .time-display { font-size: 3rem; font-weight: 300; color: #333; }
    .date-display { font-size: 1.25rem; color: #666; }
    .med-pending { background: #fff3cd; border-left: 4px solid #ffc107; }
    .med-taken { background: #d1e7dd; border-left: 4px solid #198754; }
    .med-missed { background: #f8d7da; border-left: 4px solid #dc3545; }
    .pinned-note { border-left: 4px solid #0d6efd; background: #e7f1ff; }
    .category-badge { font-size: 0.7rem; padding: 0.25rem 0.5rem; }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <%- include('_sidebar', { token, active: 'dashboard', branding, basePath }) %>

      <main class="col-md-10 ms-sm-auto main-content p-4">
        <!-- Header with Greeting -->
        <div class="d-flex justify-content-between align-items-start mb-4">
          <div>
            <div class="greeting mb-1">
              <i class="bi bi-sun text-warning me-2"></i>Good <%= new Date().getHours() < 12 ? 'Morning' : new Date().getHours() < 17 ? 'Afternoon' : 'Evening' %>, <%= user?.name?.split(' ')[0] || 'Friend' %>
            </div>
            <div class="time-display" id="currentTime"><%= new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) %></div>
            <div class="date-display"><%= new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' }) %></div>
          </div>
          <div class="d-flex gap-2">
            <a href="http://localhost:8060/" target="_blank" class="btn btn-lg btn-success px-4 py-3" data-bs-toggle="tooltip" title="Start a voice conversation with your AI assistant">
              <i class="bi bi-mic-fill me-2"></i> Talk to Me
            </a>
          </div>
        </div>

        <!-- Stats Cards -->
        <div class="row mb-4">
          <div class="col-md-3">
            <div class="card stat-card bg-primary text-white">
              <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                  <div class="stat-value"><%= stats.todayAppointments || 0 %></div>
                  <div>Today's Events</div>
                </div>
                <i class="bi bi-calendar-event stat-icon"></i>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card stat-card <%= stats.pendingMeds > 0 ? 'bg-warning text-dark' : 'bg-success text-white' %>">
              <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                  <div class="stat-value"><%= stats.pendingMeds || 0 %></div>
                  <div>Meds Pending</div>
                </div>
                <i class="bi bi-capsule stat-icon"></i>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card stat-card bg-info text-white">
              <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                  <div class="stat-value"><%= stats.activeMeds || 0 %></div>
                  <div>Medications</div>
                </div>
                <i class="bi bi-prescription2 stat-icon"></i>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card stat-card bg-secondary text-white">
              <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                  <div class="stat-value"><%= stats.totalContacts || 0 %></div>
                  <div>Contacts</div>
                </div>
                <i class="bi bi-person-rolodex stat-icon"></i>
              </div>
            </div>
          </div>
        </div>

        <div class="row">
          <!-- Left Column - Today's Schedule & Meds -->
          <div class="col-md-8">
            <!-- Today's Appointments -->
            <div class="card mb-4">
              <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-calendar-day text-primary me-2"></i>Today's Schedule</h5>
                <a href="<%= basePath %>/admin/appointments?token=<%= token %>" class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="View full calendar">
                  <i class="bi bi-calendar3"></i> Calendar
                </a>
              </div>
              <div class="card-body">
                <% if (todayAppointments && todayAppointments.length > 0) { %>
                  <% todayAppointments.forEach(appt => { %>
                  <div class="d-flex align-items-start mb-3 p-3 bg-light rounded">
                    <div class="me-3 text-center" style="min-width: 60px;">
                      <div class="fw-bold text-primary"><%= new Date(appt.startAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) %></div>
                    </div>
                    <div class="flex-grow-1">
                      <strong><%= appt.title %></strong>
                      <span class="badge category-badge bg-<%= appt.category === 'DOCTOR' ? 'danger' : appt.category === 'FINANCE' ? 'warning' : 'secondary' %> ms-2">
                        <%= appt.category %>
                      </span>
                      <% if (appt.location) { %>
                      <div class="text-muted small"><i class="bi bi-geo-alt"></i> <%= appt.location %></div>
                      <% } %>
                    </div>
                  </div>
                  <% }) %>
                <% } else { %>
                <div class="text-center text-muted py-4">
                  <i class="bi bi-calendar-x d-block mb-2" style="font-size: 2rem;"></i>
                  No appointments today. Enjoy your free day!
                </div>
                <% } %>
              </div>
            </div>

            <!-- Medications -->
            <div class="card mb-4">
              <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-capsule text-success me-2"></i>Today's Medications</h5>
                <a href="<%= basePath %>/admin/medications?token=<%= token %>" class="btn btn-sm btn-outline-success" data-bs-toggle="tooltip" title="Manage all medications">
                  <i class="bi bi-list-ul"></i> All Meds
                </a>
              </div>
              <div class="card-body">
                <% if (medications && medications.length > 0) { %>
                  <% medications.forEach(med => {
                    const schedule = typeof med.schedule === 'string' ? JSON.parse(med.schedule) : med.schedule;
                    const todayLog = med.logs && med.logs[0];
                    const status = todayLog?.status || 'PENDING';
                  %>
                  <div class="d-flex align-items-center mb-3 p-3 rounded <%= status === 'TAKEN' ? 'med-taken' : status === 'MISSED' ? 'med-missed' : 'med-pending' %>">
                    <div class="me-3 text-center" style="min-width: 70px;">
                      <div class="fw-bold"><%= schedule?.times?.[0] || '08:00' %></div>
                    </div>
                    <div class="flex-grow-1">
                      <strong><%= med.name %></strong>
                      <% if (med.dosage) { %><span class="text-muted ms-1">(<%= med.dosage %>)</span><% } %>
                      <div class="small text-muted"><%= med.instructions || '' %></div>
                    </div>
                    <div>
                      <% if (status === 'TAKEN') { %>
                      <span class="badge bg-success"><i class="bi bi-check-circle"></i> Taken</span>
                      <% } else if (status === 'MISSED') { %>
                      <span class="badge bg-danger"><i class="bi bi-x-circle"></i> Missed</span>
                      <% } else { %>
                      <button class="btn btn-sm btn-success" data-bs-toggle="tooltip" title="Mark as taken" onclick="markMedTaken('<%= med.id %>')">
                        <i class="bi bi-check"></i> Take
                      </button>
                      <% } %>
                    </div>
                  </div>
                  <% }) %>
                <% } else { %>
                <div class="text-center text-muted py-4">
                  <i class="bi bi-capsule d-block mb-2" style="font-size: 2rem;"></i>
                  No medications set up yet.
                </div>
                <% } %>
              </div>
            </div>

            <!-- Upcoming Appointments -->
            <div class="card">
              <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-calendar-week text-info me-2"></i>Coming Up</h5>
              </div>
              <div class="card-body p-0">
                <table class="table table-hover mb-0">
                  <tbody>
                    <% if (upcomingAppointments && upcomingAppointments.length > 0) { %>
                      <% upcomingAppointments.forEach(appt => { %>
                      <tr>
                        <td style="width: 120px;">
                          <small class="text-muted"><%= new Date(appt.startAt).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }) %></small><br>
                          <strong><%= new Date(appt.startAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) %></strong>
                        </td>
                        <td>
                          <strong><%= appt.title %></strong>
                          <span class="badge category-badge bg-secondary ms-2"><%= appt.category %></span>
                          <% if (appt.location) { %>
                          <div class="text-muted small"><i class="bi bi-geo-alt"></i> <%= appt.location %></div>
                          <% } %>
                        </td>
                      </tr>
                      <% }) %>
                    <% } else { %>
                    <tr>
                      <td colspan="2" class="text-center text-muted py-4">No upcoming appointments</td>
                    </tr>
                    <% } %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Right Column - Pinned Notes & Quick Actions -->
          <div class="col-md-4">
            <!-- Quick Actions -->
            <div class="card mb-4">
              <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-lightning text-warning me-2"></i>Quick Actions</h5>
              </div>
              <div class="card-body">
                <div class="d-grid gap-2">
                  <a href="<%= basePath %>/admin/appointments?token=<%= token %>" class="btn btn-outline-primary text-start" data-bs-toggle="tooltip" title="Add a new calendar appointment">
                    <i class="bi bi-calendar-plus me-2"></i> Add Appointment
                  </a>
                  <a href="<%= basePath %>/admin/medications?token=<%= token %>" class="btn btn-outline-success text-start" data-bs-toggle="tooltip" title="Add a new medication">
                    <i class="bi bi-capsule me-2"></i> Add Medication
                  </a>
                  <a href="<%= basePath %>/admin/contacts?token=<%= token %>" class="btn btn-outline-info text-start" data-bs-toggle="tooltip" title="Add a new contact">
                    <i class="bi bi-person-plus me-2"></i> Add Contact
                  </a>
                  <a href="<%= basePath %>/admin/notes?token=<%= token %>" class="btn btn-outline-secondary text-start" data-bs-toggle="tooltip" title="Create a new note">
                    <i class="bi bi-journal-plus me-2"></i> New Note
                  </a>
                </div>
              </div>
            </div>

            <!-- Pinned Notes -->
            <div class="card mb-4">
              <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-pin-angle text-primary me-2"></i>Pinned Notes</h5>
                <a href="<%= basePath %>/admin/notes?token=<%= token %>" class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="View all notes">
                  <i class="bi bi-journal-text"></i>
                </a>
              </div>
              <div class="card-body">
                <% if (pinnedNotes && pinnedNotes.length > 0) { %>
                  <% pinnedNotes.forEach(note => { %>
                  <div class="p-3 mb-2 rounded pinned-note">
                    <% if (note.title) { %><strong><%= note.title %></strong><br><% } %>
                    <span class="small"><%= note.body.substring(0, 100) %><%= note.body.length > 100 ? '...' : '' %></span>
                  </div>
                  <% }) %>
                <% } else { %>
                <div class="text-center text-muted py-3">
                  <i class="bi bi-pin d-block mb-2" style="font-size: 1.5rem;"></i>
                  No pinned notes
                </div>
                <% } %>
              </div>
            </div>

            <!-- Recent Notes -->
            <div class="card">
              <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-clock-history text-secondary me-2"></i>Recent Notes</h5>
              </div>
              <div class="card-body">
                <% if (recentNotes && recentNotes.length > 0) { %>
                  <% recentNotes.forEach(note => { %>
                  <div class="p-2 mb-2 border-bottom">
                    <% if (note.title) { %><strong><%= note.title %></strong><br><% } %>
                    <span class="small text-muted"><%= note.body.substring(0, 60) %><%= note.body.length > 60 ? '...' : '' %></span>
                  </div>
                  <% }) %>
                <% } else { %>
                <div class="text-center text-muted py-3">No recent notes</div>
                <% } %>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Initialize tooltips
    document.addEventListener('DOMContentLoaded', () => {
      const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
      tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));
    });

    // Update time every minute
    setInterval(() => {
      document.getElementById('currentTime').textContent =
        new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }, 60000);

    // Mark medication as taken
    async function markMedTaken(medId) {
      try {
        const response = await fetch(`<%= basePath %>/admin/medications/${medId}/log?token=<%= token %>`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            status: 'TAKEN',
            scheduledAt: new Date().toISOString()
          })
        });
        if (response.ok) {
          location.reload();
        }
      } catch (err) {
        console.error('Failed to mark medication taken:', err);
      }
    }
  </script>
</body>
</html>
