<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payment Gateways - Boomer AI</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    .sidebar { min-height: 100vh; background: #1e3a5f; }
    .sidebar .nav-link { color: rgba(255,255,255,0.8); padding: 0.75rem 1rem; }
    .sidebar .nav-link:hover, .sidebar .nav-link.active { color: #fff; background: rgba(255,255,255,0.1); }
    .sidebar .nav-link i { margin-right: 0.5rem; }
    .main-content { background: #f8f9fa; min-height: 100vh; }
    .nav-divider { border-top: 1px solid rgba(255,255,255,0.2); margin: 0.5rem 0; }
    .nav-section { color: rgba(255,255,255,0.5); font-size: 0.75rem; padding: 0.5rem 1rem; text-transform: uppercase; }
    .provider-section { transition: opacity 0.3s ease; }
    .provider-section.disabled { opacity: 0.5; pointer-events: none; }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <%- include('_sidebar', { token, active: 'payment-gateways' }) %>
      <main class="col-md-10 ms-sm-auto main-content p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2><i class="bi bi-credit-card-2-front text-primary me-2"></i>Payment Settings</h2>
        </div>

        <!-- Payment Gateway Configuration -->
        <div class="card mb-4">
          <div class="card-header bg-white">
            <h5 class="mb-0"><i class="bi bi-credit-card me-2"></i>Payment Gateway</h5>
            <small class="text-muted">Configure payment processors for subscriptions and in-app purchases</small>
          </div>
          <div class="card-body">
            <form id="paymentGatewayForm">
              <!-- Master Payment Gateway Toggle -->
              <div class="d-flex justify-content-between align-items-center py-3 border-bottom bg-light px-3 rounded mb-3">
                <div>
                  <h6 class="mb-1"><i class="bi bi-power text-success me-2"></i>Payment Processing</h6>
                  <small class="text-muted">Master switch - Enable/disable payment gateway integration</small>
                </div>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="payment_gateway_enabled" name="payment_gateway_enabled" style="width: 3em; height: 1.5em;" onchange="togglePaymentProviders()" <%= settings?.paymentGatewayEnabled ? 'checked' : '' %>>
                </div>
              </div>

              <div id="paymentProvidersSection" class="provider-section">
                <!-- Stripe -->
                <div class="border rounded p-3 mb-3" id="stripeSection">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                      <h6 class="mb-1"><i class="bi bi-stripe text-primary me-2" style="font-size: 1.2em;"></i>Stripe</h6>
                      <small class="text-muted">Cards + Apple Pay + Google Pay - <a href="https://stripe.com" target="_blank">stripe.com</a></small>
                    </div>
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="stripe_enabled" name="stripe_enabled" style="width: 3em; height: 1.5em;" <%= settings?.stripeEnabled ? 'checked' : '' %>>
                    </div>
                  </div>
                  <div class="row g-2" id="stripeFields">
                    <div class="col-md-6">
                      <label class="form-label small">Publishable Key</label>
                      <input type="text" class="form-control form-control-sm" id="stripe_publishable_key" name="stripe_publishable_key" placeholder="pk_live_... or pk_test_..." value="<%= settings?.stripePublishableKey || '' %>">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label small">Secret Key</label>
                      <input type="password" class="form-control form-control-sm" id="stripe_secret_key" name="stripe_secret_key" placeholder="sk_live_... or sk_test_..." autocomplete="new-password" value="<%= settings?.stripeSecretKey || '' %>">
                    </div>
                    <div class="col-6 mt-2">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="stripe_test_mode" name="stripe_test_mode" <%= settings?.stripeTestMode ? 'checked' : '' %>>
                        <label class="form-check-label small" for="stripe_test_mode">
                          <i class="bi bi-bug me-1"></i>Test Mode (use test keys)
                        </label>
                      </div>
                    </div>
                    <div class="col-6 mt-2">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="stripe_ach_enabled" name="stripe_ach_enabled" <%= settings?.stripeAchEnabled ? 'checked' : '' %>>
                        <label class="form-check-label small" for="stripe_ach_enabled">
                          <i class="bi bi-bank me-1"></i>Enable ACH Bank Transfers
                        </label>
                      </div>
                    </div>
                    <div class="col-12 mt-2" id="stripeAchInfo" style="display: none;">
                      <div class="alert alert-info small mb-0 py-2">
                        <i class="bi bi-info-circle me-1"></i>
                        <strong>ACH Direct Debit:</strong> Low-cost bank transfers for US customers.
                        Fees: 0.8% capped at $5. Processing: 1-3 business days.
                        <a href="https://stripe.com/docs/payments/ach-debit" target="_blank">Learn more</a>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Braintree -->
                <div class="border rounded p-3 mb-3" id="braintreeSection">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                      <h6 class="mb-1"><i class="bi bi-paypal text-info me-2"></i>Braintree (PayPal)</h6>
                      <small class="text-muted">Cards + PayPal + Venmo + Wallets - <a href="https://braintreepayments.com" target="_blank">braintreepayments.com</a></small>
                    </div>
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="braintree_enabled" name="braintree_enabled" style="width: 3em; height: 1.5em;" <%= settings?.braintreeEnabled ? 'checked' : '' %>>
                    </div>
                  </div>
                  <div class="row g-2" id="braintreeFields">
                    <div class="col-md-6">
                      <label class="form-label small">Merchant ID</label>
                      <input type="text" class="form-control form-control-sm" id="braintree_merchant_id" name="braintree_merchant_id" placeholder="Your Merchant ID" value="<%= settings?.braintreeMerchantId || '' %>">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label small">Public Key</label>
                      <input type="text" class="form-control form-control-sm" id="braintree_public_key" name="braintree_public_key" placeholder="Your Public Key" value="<%= settings?.braintreePublicKey || '' %>">
                    </div>
                    <div class="col-md-12">
                      <label class="form-label small">Private Key</label>
                      <input type="password" class="form-control form-control-sm" id="braintree_private_key" name="braintree_private_key" placeholder="Your Private Key" autocomplete="new-password" value="<%= settings?.braintreePrivateKey || '' %>">
                    </div>
                    <div class="col-12 mt-2">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="braintree_sandbox" name="braintree_sandbox" <%= settings?.braintreeSandbox ? 'checked' : '' %>>
                        <label class="form-check-label small" for="braintree_sandbox">
                          <i class="bi bi-bug me-1"></i>Sandbox Mode (testing)
                        </label>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- PayPal Direct -->
                <div class="border rounded p-3 mb-3" id="paypalSection">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                      <h6 class="mb-1"><i class="bi bi-paypal text-primary me-2"></i>PayPal Checkout</h6>
                      <small class="text-muted">PayPal Express Checkout - <a href="https://developer.paypal.com" target="_blank">developer.paypal.com</a></small>
                    </div>
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="paypal_enabled" name="paypal_enabled" style="width: 3em; height: 1.5em;" <%= settings?.paypalEnabled ? 'checked' : '' %>>
                    </div>
                  </div>
                  <div class="row g-2" id="paypalFields">
                    <div class="col-md-6">
                      <label class="form-label small">Client ID</label>
                      <input type="text" class="form-control form-control-sm" id="paypal_client_id" name="paypal_client_id" placeholder="Your PayPal Client ID" value="<%= settings?.paypalClientId || '' %>">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label small">Client Secret</label>
                      <input type="password" class="form-control form-control-sm" id="paypal_client_secret" name="paypal_client_secret" placeholder="Your PayPal Client Secret" autocomplete="new-password" value="<%= settings?.paypalClientSecret || '' %>">
                    </div>
                    <div class="col-12 mt-2">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="paypal_sandbox" name="paypal_sandbox" <%= settings?.paypalSandbox ? 'checked' : '' %>>
                        <label class="form-check-label small" for="paypal_sandbox">
                          <i class="bi bi-bug me-1"></i>Sandbox Mode (testing)
                        </label>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Square -->
                <div class="border rounded p-3 mb-3" id="squareSection">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                      <h6 class="mb-1"><i class="bi bi-square me-2" style="font-size: 1.2em; color: #006aff;"></i>Square</h6>
                      <small class="text-muted">Cards + Apple Pay + Google Pay - <a href="https://squareup.com" target="_blank">squareup.com</a></small>
                    </div>
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="square_enabled" name="square_enabled" style="width: 3em; height: 1.5em;" <%= settings?.squareEnabled ? 'checked' : '' %>>
                    </div>
                  </div>
                  <div class="row g-2" id="squareFields">
                    <div class="col-md-6">
                      <label class="form-label small">Application ID</label>
                      <input type="text" class="form-control form-control-sm" id="square_app_id" name="square_app_id" placeholder="sq0idp-..." value="<%= settings?.squareAppId || '' %>">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label small">Access Token</label>
                      <input type="password" class="form-control form-control-sm" id="square_access_token" name="square_access_token" placeholder="EAAAE..." autocomplete="new-password" value="<%= settings?.squareAccessToken || '' %>">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label small">Location ID</label>
                      <input type="text" class="form-control form-control-sm" id="square_location_id" name="square_location_id" placeholder="Your Location ID" value="<%= settings?.squareLocationId || '' %>">
                    </div>
                    <div class="col-6 mt-2">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="square_sandbox" name="square_sandbox" <%= settings?.squareSandbox ? 'checked' : '' %>>
                        <label class="form-check-label small" for="square_sandbox">
                          <i class="bi bi-bug me-1"></i>Sandbox Mode (testing)
                        </label>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Authorize.net -->
                <div class="border rounded p-3 mb-3" id="authorizeSection">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                      <h6 class="mb-1"><i class="bi bi-shield-check me-2 text-danger" style="font-size: 1.2em;"></i>Authorize.net</h6>
                      <small class="text-muted">Cards + eCheck - <a href="https://authorize.net" target="_blank">authorize.net</a></small>
                    </div>
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="authorize_enabled" name="authorize_enabled" style="width: 3em; height: 1.5em;" <%= settings?.authorizeEnabled ? 'checked' : '' %>>
                    </div>
                  </div>
                  <div class="row g-2" id="authorizeFields">
                    <div class="col-md-6">
                      <label class="form-label small">API Login ID</label>
                      <input type="text" class="form-control form-control-sm" id="authorize_api_login_id" name="authorize_api_login_id" placeholder="Your API Login ID" value="<%= settings?.authorizeApiLoginId || '' %>">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label small">Transaction Key</label>
                      <input type="password" class="form-control form-control-sm" id="authorize_transaction_key" name="authorize_transaction_key" placeholder="Your Transaction Key" autocomplete="new-password" value="<%= settings?.authorizeTransactionKey || '' %>">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label small">Signature Key</label>
                      <input type="text" class="form-control form-control-sm" id="authorize_signature_key" name="authorize_signature_key" placeholder="Your Signature Key" value="<%= settings?.authorizeSignatureKey || '' %>">
                    </div>
                    <div class="col-6 mt-2">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="authorize_test_mode" name="authorize_test_mode" <%= settings?.authorizeTestMode ? 'checked' : '' %>>
                        <label class="form-check-label small" for="authorize_test_mode">
                          <i class="bi bi-bug me-1"></i>Test Mode
                        </label>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="alert alert-info small mb-3">
                <i class="bi bi-info-circle me-1"></i>
                <strong>Security Note:</strong> API keys are stored securely. Never share your secret keys. Use test/sandbox mode for development.
              </div>

              <div class="alert alert-warning small mb-3">
                <i class="bi bi-exclamation-triangle me-1"></i>
                <strong>Note:</strong> You can enable multiple payment gateways. Customers will see all enabled options at checkout.
              </div>

              <button type="submit" class="btn btn-primary" data-bs-toggle="tooltip" title="Save all payment gateway settings">
                <i class="bi bi-check-lg me-1"></i> Save Payment Gateway Configuration
              </button>
            </form>
          </div>
        </div>

        <!-- Payment Methods Comparison -->
        <div class="card mb-4">
          <div class="card-header bg-white">
            <h5 class="mb-0"><i class="bi bi-table me-2"></i>Payment Provider Comparison</h5>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-sm table-bordered mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Feature</th>
                    <th class="text-center">Stripe</th>
                    <th class="text-center">Braintree</th>
                    <th class="text-center">PayPal</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>Credit/Debit Cards</td>
                    <td class="text-center"><i class="bi bi-check-circle text-success"></i></td>
                    <td class="text-center"><i class="bi bi-check-circle text-success"></i></td>
                    <td class="text-center"><i class="bi bi-check-circle text-success"></i></td>
                  </tr>
                  <tr>
                    <td>Apple Pay</td>
                    <td class="text-center"><i class="bi bi-check-circle text-success"></i></td>
                    <td class="text-center"><i class="bi bi-check-circle text-success"></i></td>
                    <td class="text-center"><i class="bi bi-dash text-muted"></i></td>
                  </tr>
                  <tr>
                    <td>Google Pay</td>
                    <td class="text-center"><i class="bi bi-check-circle text-success"></i></td>
                    <td class="text-center"><i class="bi bi-check-circle text-success"></i></td>
                    <td class="text-center"><i class="bi bi-dash text-muted"></i></td>
                  </tr>
                  <tr>
                    <td>PayPal</td>
                    <td class="text-center"><i class="bi bi-dash text-muted"></i></td>
                    <td class="text-center"><i class="bi bi-check-circle text-success"></i></td>
                    <td class="text-center"><i class="bi bi-check-circle text-success"></i></td>
                  </tr>
                  <tr>
                    <td>Venmo</td>
                    <td class="text-center"><i class="bi bi-dash text-muted"></i></td>
                    <td class="text-center"><i class="bi bi-check-circle text-success"></i></td>
                    <td class="text-center"><i class="bi bi-dash text-muted"></i></td>
                  </tr>
                  <tr>
                    <td>ACH Bank Transfer</td>
                    <td class="text-center"><i class="bi bi-check-circle text-success"></i></td>
                    <td class="text-center"><i class="bi bi-dash text-muted"></i></td>
                    <td class="text-center"><i class="bi bi-dash text-muted"></i></td>
                  </tr>
                  <tr>
                    <td>Recurring Billing</td>
                    <td class="text-center"><i class="bi bi-check-circle text-success"></i></td>
                    <td class="text-center"><i class="bi bi-check-circle text-success"></i></td>
                    <td class="text-center"><i class="bi bi-check-circle text-success"></i></td>
                  </tr>
                  <tr>
                    <td>Transaction Fee</td>
                    <td class="text-center">2.9% + 30¢</td>
                    <td class="text-center">2.59% + 49¢</td>
                    <td class="text-center">2.89% + 49¢</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const token = '<%= token %>';

    document.addEventListener('DOMContentLoaded', () => {
      // Initialize tooltips
      const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
      tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));

      // Set initial state
      togglePaymentProviders();
      handleAchToggle();
    });

    function togglePaymentProviders() {
      const masterToggle = document.getElementById('payment_gateway_enabled');
      const providersSection = document.getElementById('paymentProvidersSection');

      if (masterToggle && providersSection) {
        if (masterToggle.checked) {
          providersSection.classList.remove('disabled');
        } else {
          providersSection.classList.add('disabled');
        }
      }
    }

    function handleAchToggle() {
      const achToggle = document.getElementById('stripe_ach_enabled');
      const achInfo = document.getElementById('stripeAchInfo');

      if (achToggle && achInfo) {
        achInfo.style.display = achToggle.checked ? 'block' : 'none';

        achToggle.addEventListener('change', function() {
          achInfo.style.display = this.checked ? 'block' : 'none';
        });
      }
    }

    document.getElementById('paymentGatewayForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = {
        paymentGatewayEnabled: document.getElementById('payment_gateway_enabled').checked,
        stripeEnabled: document.getElementById('stripe_enabled').checked,
        stripePublishableKey: document.getElementById('stripe_publishable_key').value,
        stripeSecretKey: document.getElementById('stripe_secret_key').value,
        stripeTestMode: document.getElementById('stripe_test_mode').checked,
        stripeAchEnabled: document.getElementById('stripe_ach_enabled').checked,
        braintreeEnabled: document.getElementById('braintree_enabled').checked,
        braintreeMerchantId: document.getElementById('braintree_merchant_id').value,
        braintreePublicKey: document.getElementById('braintree_public_key').value,
        braintreePrivateKey: document.getElementById('braintree_private_key').value,
        braintreeSandbox: document.getElementById('braintree_sandbox').checked,
        paypalEnabled: document.getElementById('paypal_enabled').checked,
        paypalClientId: document.getElementById('paypal_client_id').value,
        paypalClientSecret: document.getElementById('paypal_client_secret').value,
        paypalSandbox: document.getElementById('paypal_sandbox').checked,
        // Square
        squareEnabled: document.getElementById('square_enabled').checked,
        squareAppId: document.getElementById('square_app_id').value,
        squareAccessToken: document.getElementById('square_access_token').value,
        squareLocationId: document.getElementById('square_location_id').value,
        squareSandbox: document.getElementById('square_sandbox').checked,
        // Authorize.net
        authorizeEnabled: document.getElementById('authorize_enabled').checked,
        authorizeApiLoginId: document.getElementById('authorize_api_login_id').value,
        authorizeTransactionKey: document.getElementById('authorize_transaction_key').value,
        authorizeSignatureKey: document.getElementById('authorize_signature_key').value,
        authorizeTestMode: document.getElementById('authorize_test_mode').checked
      };

      try {
        const response = await fetch(`<%= basePath %>/admin/payment-settings?token=${token}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(formData)
        });

        const data = await response.json();

        if (data.success) {
          showAlert('success', 'Payment gateway configuration saved successfully');
        } else {
          showAlert('danger', data.error || 'Failed to save payment gateway settings');
        }
      } catch (error) {
        console.error('Error saving payment gateway:', error);
        showAlert('danger', 'Error saving payment gateway settings: ' + error.message);
      }
    });

    function showAlert(type, message) {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
      alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
      alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      document.body.appendChild(alertDiv);

      setTimeout(() => {
        alertDiv.remove();
      }, 5000);
    }
  </script>
</body>
</html>
