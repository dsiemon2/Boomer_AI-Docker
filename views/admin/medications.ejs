<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Medications - Boomer AI</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    .sidebar { min-height: 100vh; background: #2d5a3d; }
    .sidebar .nav-link { color: rgba(255,255,255,0.8); padding: 0.75rem 1rem; }
    .sidebar .nav-link:hover, .sidebar .nav-link.active { color: #fff; background: rgba(255,255,255,0.1); }
    .sidebar .nav-link i { margin-right: 0.5rem; }
    .main-content { background: #f8f9fa; min-height: 100vh; }
    .nav-divider { border-top: 1px solid rgba(255,255,255,0.2); margin: 0.5rem 0; }
    .nav-section { color: rgba(255,255,255,0.5); font-size: 0.75rem; padding: 0.5rem 1rem; text-transform: uppercase; }
    .med-card { border-radius: 12px; border-left: 4px solid #198754; }
    .med-card.inactive { opacity: 0.6; border-left-color: #6c757d; }
    .schedule-badge { font-size: 0.75rem; }
    .log-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }
    .log-dot.taken { background: #198754; }
    .log-dot.missed { background: #dc3545; }
    .log-dot.pending { background: #ffc107; }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <%- include('_sidebar', { token, active: 'medications' }) %>

      <main class="col-md-10 ms-sm-auto main-content p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2><i class="bi bi-capsule text-success me-2"></i>Medications</h2>
          <div>
            <a href="<%= basePath %>/admin/medications?inactive=<%= showInactive ? 'false' : 'true' %>&token=<%= token %>" class="btn btn-outline-secondary me-2" data-bs-toggle="tooltip" title="<%= showInactive ? 'Hide' : 'Show' %> inactive medications">
              <i class="bi bi-eye<%= showInactive ? '-slash' : '' %>"></i> <%= showInactive ? 'Hide' : 'Show' %> Inactive
            </a>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addModal">
              <i class="bi bi-plus-lg"></i> Add Medication
            </button>
          </div>
        </div>

        <!-- Medications Grid -->
        <div class="row">
          <% if (medications && medications.length > 0) { %>
            <% medications.forEach(med => { %>
            <div class="col-md-6 col-lg-4 mb-4">
              <div class="card med-card h-100 <%= !med.isActive ? 'inactive' : '' %>">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                      <h5 class="mb-0"><%= med.name %></h5>
                      <% if (med.dosage) { %>
                      <small class="text-muted"><%= med.dosage %></small>
                      <% } %>
                    </div>
                    <span class="badge bg-<%= med.form === 'PILL' ? 'primary' : med.form === 'CAPSULE' ? 'info' : 'secondary' %>">
                      <%= med.form %>
                    </span>
                  </div>

                  <% if (med.instructions) { %>
                  <p class="text-muted small mb-2"><%= med.instructions %></p>
                  <% } %>

                  <div class="mb-3">
                    <small class="text-muted">Schedule:</small>
                    <div>
                      <% (med.schedule?.times || ['08:00']).forEach(time => { %>
                      <span class="badge schedule-badge bg-light text-dark me-1"><%= time %></span>
                      <% }) %>
                    </div>
                  </div>

                  <% if (med.prescribedBy || med.pharmacy) { %>
                  <div class="mb-3 small">
                    <% if (med.prescribedBy) { %><div><i class="bi bi-person"></i> <%= med.prescribedBy %></div><% } %>
                    <% if (med.pharmacy) { %><div><i class="bi bi-shop"></i> <%= med.pharmacy %></div><% } %>
                  </div>
                  <% } %>

                  <% if (med.pillsRemaining !== null) { %>
                  <div class="mb-3">
                    <small class="text-muted">Pills remaining:</small>
                    <span class="badge bg-<%= med.pillsRemaining < 10 ? 'danger' : med.pillsRemaining < 20 ? 'warning' : 'success' %>"><%= med.pillsRemaining %></span>
                  </div>
                  <% } %>

                  <!-- 7-day history -->
                  <div class="mb-3">
                    <small class="text-muted d-block mb-1">Last 7 days:</small>
                    <% for (let i = 0; i < 7; i++) {
                      const log = med.logs && med.logs[i];
                      const status = log?.status || 'pending';
                    %>
                    <span class="log-dot <%= status === 'TAKEN' ? 'taken' : status === 'MISSED' ? 'missed' : 'pending' %>"
                          data-bs-toggle="tooltip"
                          title="<%= status %>"></span>
                    <% } %>
                  </div>
                </div>
                <div class="card-footer bg-white">
                  <div class="d-flex justify-content-between">
                    <button class="btn btn-sm btn-outline-success" data-bs-toggle="tooltip" title="Mark as taken" onclick="markTaken('<%= med.id %>')">
                      <i class="bi bi-check"></i> Taken
                    </button>
                    <div>
                      <button class="btn btn-sm btn-outline-secondary me-1" data-bs-toggle="tooltip" title="<%= med.isActive ? 'Deactivate' : 'Activate' %>" onclick="toggleActive('<%= med.id %>')">
                        <i class="bi bi-<%= med.isActive ? 'pause' : 'play' %>"></i>
                      </button>
                      <button class="btn btn-sm btn-outline-danger" data-bs-toggle="tooltip" title="Delete medication" onclick="deleteMed('<%= med.id %>')">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <% }) %>
          <% } else { %>
          <div class="col-12">
            <div class="card">
              <div class="card-body text-center py-5">
                <i class="bi bi-capsule d-block mb-3" style="font-size: 3rem; color: #ccc;"></i>
                <h5 class="text-muted">No medications found</h5>
                <p class="text-muted">Add your first medication to start tracking.</p>
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addModal">
                  <i class="bi bi-plus-lg"></i> Add Medication
                </button>
              </div>
            </div>
          </div>
          <% } %>
        </div>
      </main>
    </div>
  </div>

  <!-- Add Modal -->
  <div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-capsule me-2"></i>Add Medication</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="medForm">
            <div class="mb-3">
              <label class="form-label">Medication Name *</label>
              <input type="text" class="form-control form-control-lg" name="name" required placeholder="e.g., Lisinopril">
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Form</label>
                <select class="form-select" name="form">
                  <option value="PILL">Pill</option>
                  <option value="CAPSULE">Capsule</option>
                  <option value="LIQUID">Liquid</option>
                  <option value="INJECTION">Injection</option>
                  <option value="TOPICAL">Topical</option>
                  <option value="INHALER">Inhaler</option>
                  <option value="DROPS">Drops</option>
                  <option value="OTHER">Other</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Dosage</label>
                <input type="text" class="form-control" name="dosage" placeholder="e.g., 10 mg">
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Instructions</label>
              <input type="text" class="form-control" name="instructions" placeholder="e.g., Take with food">
            </div>
            <div class="mb-3">
              <label class="form-label">Times per day</label>
              <select class="form-select" name="timesPerDay" id="timesPerDay">
                <option value="1">Once daily</option>
                <option value="2">Twice daily</option>
                <option value="3">Three times daily</option>
                <option value="4">Four times daily</option>
              </select>
            </div>
            <div class="mb-3" id="timesContainer">
              <label class="form-label">Time(s)</label>
              <input type="time" class="form-control mb-2" name="time1" value="08:00">
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Prescribed by</label>
                <input type="text" class="form-control" name="prescribedBy" placeholder="Doctor name">
              </div>
              <div class="col-md-6">
                <label class="form-label">Pharmacy</label>
                <input type="text" class="form-control" name="pharmacy" placeholder="Pharmacy name">
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" onclick="saveMedication()">
            <i class="bi bi-check-lg"></i> Save
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
      tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));

      // Update time inputs based on times per day
      document.getElementById('timesPerDay').addEventListener('change', function() {
        const count = parseInt(this.value);
        const container = document.getElementById('timesContainer');
        const defaultTimes = ['08:00', '12:00', '18:00', '22:00'];

        let html = '<label class="form-label">Time(s)</label>';
        for (let i = 0; i < count; i++) {
          html += `<input type="time" class="form-control mb-2" name="time${i+1}" value="${defaultTimes[i] || '08:00'}">`;
        }
        container.innerHTML = html;
      });
    });

    async function saveMedication() {
      const form = document.getElementById('medForm');
      const formData = new FormData(form);
      const timesPerDay = parseInt(formData.get('timesPerDay'));
      const times = [];
      for (let i = 1; i <= timesPerDay; i++) {
        const time = formData.get(`time${i}`);
        if (time) times.push(time);
      }

      const data = {
        name: formData.get('name'),
        form: formData.get('form'),
        dosage: formData.get('dosage'),
        instructions: formData.get('instructions'),
        prescribedBy: formData.get('prescribedBy'),
        pharmacy: formData.get('pharmacy'),
        schedule: { times, daysOfWeek: [0, 1, 2, 3, 4, 5, 6] }
      };

      try {
        const response = await fetch('<%= basePath %>/admin/medications?token=<%= token %>', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (response.ok) {
          location.reload();
        } else {
          alert('Failed to save medication');
        }
      } catch (err) {
        console.error(err);
        alert('Error saving medication');
      }
    }

    async function markTaken(id) {
      try {
        const response = await fetch(`<%= basePath %>/admin/medications/${id}/log?token=<%= token %>`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: 'TAKEN', scheduledAt: new Date().toISOString() })
        });
        if (response.ok) {
          location.reload();
        }
      } catch (err) {
        console.error(err);
      }
    }

    async function toggleActive(id) {
      try {
        const response = await fetch(`<%= basePath %>/admin/medications/${id}/toggle?token=<%= token %>`, { method: 'PUT' });
        if (response.ok) {
          location.reload();
        }
      } catch (err) {
        console.error(err);
      }
    }

    async function deleteMed(id) {
      if (!confirm('Are you sure you want to delete this medication?')) return;
      try {
        const response = await fetch(`<%= basePath %>/admin/medications/${id}?token=<%= token %>`, { method: 'DELETE' });
        if (response.ok) {
          location.reload();
        }
      } catch (err) {
        console.error(err);
      }
    }
  </script>
</body>
</html>
